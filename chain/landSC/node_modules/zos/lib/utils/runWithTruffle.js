'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _Truffle = require('../models/truffle/Truffle');

var _Truffle2 = _interopRequireDefault(_Truffle);

var _Session = require('../models/network/Session');

var _Session2 = _interopRequireDefault(_Session);

var _Contracts = require('zos-lib/lib/utils/Contracts');

var _Contracts2 = _interopRequireDefault(_Contracts);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_TIMEOUT = 10 * 60; // 10 minutes

exports.default = async function runWithTruffle(script, options) {
  const config = _Truffle2.default.config();
  const { network, from, timeout } = _Session2.default.getOptions(options);
  const txParams = from ? { from } : {};

  if (!network) throw Error('A network name must be provided to execute the requested action.');
  config.network = network;
  _Contracts2.default.setSyncTimeout((_lodash2.default.isNil(timeout) ? DEFAULT_TIMEOUT : timeout) * 1000);
  if (options.compile) await _Truffle2.default.compile(config);
  initTruffle(config).then(() => script({ network, txParams }));
};

function initTruffle(config) {
  return new Promise((resolve, reject) => {
    const TruffleEnvironment = require('truffle-core/lib/environment');
    TruffleEnvironment.detect(config, function (error) {
      if (error) reject(error);
      const Web3 = require('web3');
      global.web3 = new Web3(config.provider);
      global.artifacts = config.resolver;
      resolve();
    });
  });
}

module.exports.DEFAULT_TIMEOUT = DEFAULT_TIMEOUT;